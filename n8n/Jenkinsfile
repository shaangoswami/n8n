pipeline {
    agent any
    environment {
        DOCKER_IMAGE = "shaangoswami/n8n-image"
        DOCKER_TAG = "v1"
        KUBE_NAMESPACE = "default"
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Deploy') {
            steps {
                withKubeConfig([credentialsId: 'my-k8s-config']) {
                    sh """
                    echo "--- INSTALLING KUBECTL ---"
                    curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
                    chmod +x ./kubectl
                    
                    echo "--- FINDING DEPLOYMENT FILE ---"
                    DEPLOY_FILE=\$(find . -name "deployment.yaml" | head -n 1)
                    
                    if [ -z "\$DEPLOY_FILE" ]; then
                        echo "ERROR: deployment.yaml not found!"
                        exit 1
                    fi
                    
                    WORK_DIR=\$(dirname "\$DEPLOY_FILE")
                    
                    echo "--- DEPLOYING ---"
                    sed -i 's|image: .*|image: ${DOCKER_IMAGE}:${DOCKER_TAG}|g' "\$DEPLOY_FILE"
                    
                    ./kubectl apply -f "\$WORK_DIR" -n ${KUBE_NAMESPACE}
                    ./kubectl rollout restart deployment/n8n -n ${KUBE_NAMESPACE} || true
                    """
                }
            }
        }
    }
}
