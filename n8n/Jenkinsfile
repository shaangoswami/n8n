pipeline {
    agent any
    environment {
        DOCKER_IMAGE = "shaangoswami/n8n-image"
        DOCKER_TAG = "v1"
        KUBE_NAMESPACE = "default"
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Deploy') {
            steps {
                withKubeConfig([credentialsId: 'my-k8s-config']) {
                    sh """
                    echo "--- DEBUG: WHERE ARE MY FILES? ---"
                    # Find deployment.yaml anywhere in the workspace
                    DEPLOY_FILE=\$(find . -name "deployment.yaml" | head -n 1)
                    
                    if [ -z "\$DEPLOY_FILE" ]; then
                        echo "CRITICAL ERROR: deployment.yaml not found in workspace!"
                        ls -R # List everything to help debug
                        exit 1
                    fi
                    
                    echo "FOUND IT AT: \$DEPLOY_FILE"
                    # Get the folder containing the file
                    WORK_DIR=\$(dirname "\$DEPLOY_FILE")
                    
                    echo "Deploying from: \$WORK_DIR"
                    
                    # Update the image
                    sed -i 's|image: .*|image: ${DOCKER_IMAGE}:${DOCKER_TAG}|g' "\$DEPLOY_FILE"
                    
                    # Apply everything in that folder
                    kubectl apply -f "\$WORK_DIR" -n ${KUBE_NAMESPACE}
                    
                    # Restart
                    kubectl rollout restart deployment/n8n -n ${KUBE_NAMESPACE} || true
                    """
                }
            }
        }
    }
}
