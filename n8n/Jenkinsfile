pipeline {
    agent any
    environment {
        DOCKER_IMAGE = "shaangoswami/n8n-image"
        DOCKER_TAG = "v1"
        // The path ON THE HOST MACHINE where you want to deploy
        HOST_PATH = "/home/vkpatel/n8n/n8n" 
    }

    stages {
        stage('Deploy via SSH') {
            steps {
                sshagent(['host-ssh']) { // Use the ID of your SSH credentials
                    sh """
                    # Connect to the host (kc-m1) and run commands there
                    ssh -o StrictHostKeyChecking=no vkpatel@10.20.4.221 << EOF
                        
                        cd ${HOST_PATH}
                        
                        echo "--- UPDATING DEPLOYMENT ON HOST ---"
                        # Update the file directly on the host
                        sed -i 's|image: .*|image: ${DOCKER_IMAGE}:${DOCKER_TAG}|g' deployment.yaml
                        
                        echo "--- APPLYING CONFIG ---"
                        # Use microk8s kubectl which definitely exists on the host
                        microk8s kubectl apply -f .
                        
                        echo "--- RESTARTING ---"
                        microk8s kubectl rollout restart deployment/n8n
                        
                    EOF
                    """
                }
            }
        }
    }
}
